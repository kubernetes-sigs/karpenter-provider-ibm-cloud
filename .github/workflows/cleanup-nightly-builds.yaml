name: Cleanup Old Nightly Builds

on:
  schedule:
    # Run weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      retention_days:
        description: 'Number of days to retain nightly builds'
        required: false
        default: '7'
      dry_run:
        description: 'Dry run (show what would be deleted without deleting)'
        required: false
        type: boolean
        default: false

env:
  QUAY_REPO: karpenter-provider-ibm-cloud/controller

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Cleanup old nightly builds from Quay.io
        env:
          QUAY_TOKEN: ${{ secrets.QUAY_TOKEN }}
        run: |
          set -euo pipefail

          RETENTION_DAYS="${{ github.event.inputs.retention_days || '7' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          QUAY_API="https://quay.io/api/v1"

          echo "Retention period: ${RETENTION_DAYS} days"
          echo "Dry run: ${DRY_RUN}"
          echo "Repository: ${QUAY_REPO}"

          # Calculate cutoff date in seconds since epoch
          CUTOFF_DATE=$(date -d "-${RETENTION_DAYS} days" +%s)
          echo "Cutoff date: $(date -d "@${CUTOFF_DATE}" --iso-8601=seconds)"

          # Fetch all tags from Quay.io
          echo "Fetching tags from Quay.io..."
          TAGS_RESPONSE=$(curl -s -H "Authorization: Bearer ${QUAY_TOKEN}" \
            "${QUAY_API}/repository/${QUAY_REPO}/tag/?limit=100")

          if echo "${TAGS_RESPONSE}" | jq -e '.error' > /dev/null 2>&1; then
            echo "Error fetching tags: $(echo "${TAGS_RESPONSE}" | jq -r '.error')"
            exit 1
          fi

          # Parse tags and filter nightly builds
          TOTAL_TAGS=$(echo "${TAGS_RESPONSE}" | jq '.tags | length')
          echo "Total tags found: ${TOTAL_TAGS}"

          # Filter nightly tags (contain 'nightly' or match version pattern with date)
          NIGHTLY_TAGS=$(echo "${TAGS_RESPONSE}" | jq -r '.tags[] | select(
            (.name | contains("nightly")) or
            (.name | test("v[0-9]+\\.[0-9]+\\.[0-9]+-[0-9]{4}-[0-9]{2}-[0-9]{2}-[a-f0-9]+-"))
          )')

          NIGHTLY_COUNT=$(echo "${NIGHTLY_TAGS}" | jq -s 'length')
          echo "Nightly tags found: ${NIGHTLY_COUNT}"

          if [ "${NIGHTLY_COUNT}" -eq 0 ]; then
            echo "No nightly builds found. Nothing to clean up."
            exit 0
          fi

          # Create summary header
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # Nightly Build Cleanup Summary

          - **Retention Period**: ${RETENTION_DAYS} days
          - **Cutoff Date**: $(date -d "@${CUTOFF_DATE}" --iso-8601=seconds)
          - **Total Tags**: ${TOTAL_TAGS}
          - **Nightly Tags**: ${NIGHTLY_COUNT}
          - **Dry Run**: ${DRY_RUN}

          ## Tags to be deleted:

          | Tag | Last Modified |
          |-----|---------------|
          EOF

          DELETED_COUNT=0

          # Process each nightly tag
          echo "${TAGS_RESPONSE}" | jq -c '.tags[] | select(
            (.name | contains("nightly")) or
            (.name | test("v[0-9]+\\.[0-9]+\\.[0-9]+-[0-9]{4}-[0-9]{2}-[0-9]{2}-[a-f0-9]+-"))
          )' | while read -r TAG_JSON; do
            TAG_NAME=$(echo "${TAG_JSON}" | jq -r '.name')
            LAST_MODIFIED=$(echo "${TAG_JSON}" | jq -r '.last_modified')

            # Skip the 'nightly' tag itself (it's the floating latest tag)
            if [ "${TAG_NAME}" = "nightly" ]; then
              echo "Skipping floating 'nightly' tag"
              continue
            fi

            # Convert last_modified to epoch (format: "Tue, 25 Feb 2025 15:12:53 -0000")
            TAG_DATE=$(date -d "${LAST_MODIFIED}" +%s 2>/dev/null || echo "0")

            if [ "${TAG_DATE}" -lt "${CUTOFF_DATE}" ]; then
              echo "| ${TAG_NAME} | ${LAST_MODIFIED} |" >> $GITHUB_STEP_SUMMARY

              if [ "${DRY_RUN}" = "false" ]; then
                echo "Deleting tag: ${TAG_NAME}"
                DELETE_RESPONSE=$(curl -s -X DELETE \
                  -H "Authorization: Bearer ${QUAY_TOKEN}" \
                  "${QUAY_API}/repository/${QUAY_REPO}/tag/${TAG_NAME}")

                if echo "${DELETE_RESPONSE}" | jq -e '.error' > /dev/null 2>&1; then
                  echo "Warning: Failed to delete ${TAG_NAME}: $(echo "${DELETE_RESPONSE}" | jq -r '.error')"
                else
                  echo "Deleted: ${TAG_NAME}"
                  DELETED_COUNT=$((DELETED_COUNT + 1))
                fi
              else
                echo "Would delete: ${TAG_NAME}"
              fi
            fi
          done

          if [ "${DRY_RUN}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Dry run completed - no tags were actually deleted**" >> $GITHUB_STEP_SUMMARY
            echo "Dry run completed - no tags were actually deleted"
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Cleanup completed**" >> $GITHUB_STEP_SUMMARY
            echo "Cleanup completed"
          fi
